---
title: "Regression Discontinuity"
author: "SX and EJT"
output: rmarkdown::github_document
---

## Loading packages

```{r warning=FALSE, message = FALSE}
library(MASS)
library(leaps)
library(ggplot2)
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(RColorBrewer)
library(stringr)
library(magrittr)
library(lme4)
library(AICcmodavg)
library(broom)
library(broom.mixed)
library(RCurl)
library(modelsummary)
```

## 1. Loading the example datafile

Before running the RD analysis, we can load example data from GitHub and center the running variable. In the example data, the running variable is named as *Running* and the intervention status is indicated by a binary variable, *Reachout*.

```{r}
# Load the sample data from GitHub
Data_comp <- read.csv(text=getURL("https://raw.githubusercontent.com/TheobaldLab/RegressionDiscontinuity/refs/heads/main/RD_WrokingData.csv"))

# Centering the running variable at 71.5 points for regression analysis
Data_comp <- Data_comp %>%
  mutate(c_running = Running - 71.5)

```
We should note that for the privacy purpose, we removed all identifiable information.

## 2. Checking threshold and sharpness

In Section *Setting up an RD design: A pre-determined threshold*, we described two assumptions that help set up the RD study. First of all, we can check the number of non-compilers

```{r}
# check number of non-compilers
Data_comp <- Data_comp %>%
mutate(
  Below = case_when(
    Running >=71.5 ~ "0",
    Running < 71.5 ~ "1",
    TRUE ~ "NA"
  )
)
Data_comp <- Data_comp %>%
  mutate(
    Compliance = case_when(
      Below == 1 & Reachout == 1 ~ "1",
      Below == 0 & Reachout == 0 ~ "1",
      Below == 1 & Reachout == 0 ~ "0",
      Below == 0 & Reachout == 1 ~ "0",
      TRUE ~ "NA"
    )
  )
table(Data_comp$Compliance)

```

Out of 3063 participated students, there was only one non-compiler, indicating that a sharp RD can be used. Second, we can visually examine the continuity of the running variable, in particular around the threshold (Figure 2 in the paper).

```{r warning=FALSE}
# Create Figure 2 
Data_comp %>%
  ggplot(aes(x = Running, y = Reachout, color = as.factor(Reachout)))+
  geom_point(size = 1.5, alpha = 0.5, position = position_jitter(width = 0, height = 0.25, seed = 1234))+ ggtitle("Figure 2 Visualization of clearly-defined threshold of intervention \n assignment along a continuous running variable")+
  geom_vline(xintercept = 71.5) + xlim(40,100)+ #limit the range of x for a better visualization
  scale_color_manual(values=c("mediumpurple", "#E69F00"),  labels = c("No", "Yes")) +
  theme(
    panel.border = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
    panel.grid = element_blank(),
    legend.key = element_rect(fill = "transparent", color = NA)
    )+
  labs(x = "Cumulative Grade Before Reaching Out", y = "Reaching Out Status", color = "Reached Out")+
  scale_y_continuous(breaks = seq(0,1, by = 1))
```

## 3. Setting a comparable condition through bandwidth selection

In the paper, we presented two approaches that examined bandwidth. First, we created scatter plots of the learning outcome (the next exam scores) against centered running variable, and narrowed bandwidths (Figure 3 in the paper).

For example, a scatter plot with a bandwidth of 30 points can be generated by the following codes

```{r warning=FALSE, message = FALSE}
# Figure 3c
Data_comp %>%
  ggplot(aes(x = c_running, y = Next, color = as.factor(Reachout)))+
  ggtitle ("Figure 3 Creating comparable samples by narrowing samples \n around threshold (Figure 3c in the paper)")+
  geom_point(size = 1.5, alpha = 0.5) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks = seq(-20, 20, by = 5))+
  scale_y_continuous(breaks = seq(30, 100, by = 5))+
  xlim(-15, 15)+ # readers can change the bandwidth by changing the coefficients
  ylim(30,100)+ 
  scale_color_manual(values=c("mediumpurple", "#E69F00"),  labels = c("No", "Yes"))+
  labs(x = "Centered Cumulative Grade Before Reaching Out", y = "Next Exam", color = "Reached Out") +
  theme(
    panel.border = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
    panel.grid = element_blank(),
    legend.key = element_rect(fill = "transparent", color = NA)
  )
```

Next, we checked the covariate balance (Table 1 in the paper) by estimating each key covariate (i.e., first generation status, gender, and racial minority status) using reaching out status. For example, the codes below examine the balance of *first generation status* by bandwidths (full sample, 40 points, and 30 points).

```{r}
# Full sample
full <- lm(Firstgen ~ Reachout, data = Data_comp)
summary(full)

# Bandwidth of 40 points
band_40 <- lm(Firstgen ~ Reachout, data = filter(Data_comp, c_running>= -20 & c_running <=20))
summary(band_40)

# Bandwidth of 30 points
band_30 <- lm(Firstgen ~ Reachout, data = filter(Data_comp, c_running>= -15 & c_running <=15))
summary(band_30)
```

To understand the covariate balance, we are looking at the estimations of **Reachout** on first generation status and their significant levels. At the full sample, the estimation is -0.065 and significant at 0.01 level, whereas at bandwidths of 40 and 30 points, both estimations are not significant. Please see Table 1 in the paper for more covariate balance checking information.

## 4.Baseline RD model
In the paper, we demonstrated the baseline RD model in the forms of visualization (Figure 4) and model estimation results (Table 2) and utlized the baseline model to search for optimal bandwidth (Figure 5). The codes below explain each step. 

First we create the visualization shown in Figure 4.
```{r warning=FALSE, message = FALSE}
# Figure 4
Data_comp %>%
  ggplot(aes(x = c_running, y = Next, color = as.factor(Reachout)))+
  ggtitle("Figure 4. Visualization of baseline Regression Discontinuity (RD) \n estimation (Bandwidth = 26 points, n = 1335)") +
  geom_point(size = 1.5, alpha = 0.5) +
  geom_smooth(data = filter(Data_comp, Running <= 71.5 & Reachout == 1), method = "lm", se = F)+ #adding fitted line for treated students
  geom_smooth(data = filter(Data_comp, Running > 71.5 & Reachout == 0), method = "lm", se = F)+ #adding fitted lien for untreated students
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks = seq(-20, 20, by = 5))+
  scale_y_continuous(breaks = seq(40, 100, by = 10), limits = c(40, 100))+
  xlim(-13, 13)+ #limit the sample to a bandwidth of 26 points
  scale_color_manual(values=c("mediumpurple", "#E69F00"),  labels = c("No", "Yes"))+
  labs(x = "Centered Cumulative Grade Before Reaching Out", y = "Next Exam", color = "Reached Out")+
  theme(
    panel.border = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
    panel.grid = element_blank(),
    legend.key = element_rect(fill = "transparent", color = NA)
  )
```

Second, following Equation (1) in the paper, we can run the RD model and get coefficients in Table 2. The codes below generate the baseline RD model estimation, using a bandwidth of 30 points as an example. 
```{r}
baseline_30 <- lm(Next ~ Reachout + c_running, data = filter(Data_comp, c_running>= -15 & c_running <=15)) #change the range for different bandwidths
summary(baseline_30)
```
As shown in the model summary, at a bandwidth of 30 points, the estimated effect of reaching out is 3.88 points and is significant at the 0.05 level.

Finally, using the baseline RD model specification, we can go through bandwidths from 2 points to 60 points to search for optimal bandwidth. The codes below create Figure 5 in the paper.
```{r warning=FALSE, message = FALSE}
# Figure 5
results <- data.frame(Bandwidth = integer(),  #create a blank data frame to store regression results 
                      Treatment_Effect = numeric(), 
                      CI_Lower = numeric(), 
                      CI_Upper = numeric(), 
                      p_value = numeric())

for (bw in seq(1,30, by = 0.5)) {   #loop through bandwidths from 2 to 60, with the increment of 1 point
  subset_data <- subset(Data_comp, abs(c_running) <= bw) #create sub-sample with the current bandwidth
  model <- lm(Next ~ Reachout + c_running, data = subset_data)  #run the RD model
  treatment_effect <- coef(model)["Reachout"]  #extract related information
  conf_int <- confint(model, "Reachout", level = 0.95)
  p_value <- tidy(model) %>% filter(term == "Reachout") %>% pull(p.value)
  results <- rbind(results,   #store the bandwidth, coefficients, and p-values
                   data.frame(Bandwidth = bw*2, 
                              Treatment_Effect = treatment_effect, 
                              CI_Lower = conf_int[1], 
                              CI_Upper = conf_int[2], 
                              p_value = p_value))
}

results <- results %>%  #add a set of new results each time after each run
  mutate(Significance = ifelse(p_value < 0.05, "Significant", "Not Significant"))

results <- results %>%  #indicate sig/non-sig results
  mutate(Group = cumsum(Significance != lag(Significance, default = first(Significance))))

plot_next <-  ggplot(results, aes(x = Bandwidth, y = Treatment_Effect, color = Significance)) +
  geom_line(aes(group = Group), size = 1) +  
  geom_line(aes(y = CI_Lower, linetype = "Confidence Interval"), color = "black", show.legend = TRUE) +
  geom_line(aes(y = CI_Upper, linetype = "Confidence Interval"), color = "black", show.legend = TRUE) +
  geom_point(aes(shape = Significance), size = 2) +  # Points to indicate significance
  scale_color_manual(values = c("Significant" = "mediumpurple", "Not Significant" = "#E69F00")) +
  ggtitle ("Figure 5. Bandwidth selection using baseline RD models \n with significant levels and Confidence Intervals") +
  scale_linetype_manual(name = "Legend", values = c("Confidence Interval" = "dashed")) +
  labs(x = "Bandwidth",
       y = "Treatment Effect on the Next Exam") +
  theme_minimal() +
  guides(
    color = guide_legend(title = "Significance at .05 Level"),
    linetype = guide_legend(title = "95% Confidence Interval"),
    shape = guide_legend(title = "Significance at .05 Level")
  ) +
  theme(
    panel.border = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
  ) +
  scale_y_continuous(breaks = seq(-10,20, by = 1)) + ylim(-15,20) +
  scale_x_continuous(breaks = seq(0,60, by = 10))
 
plot_next
```

Please see the paper for full interpretation of Figure 5.

## 5. Fixed-effect model in RD framework
Fixed-effect models are useful to test additional hypotheses under an RD analysis. In the paper, we added the interaction terms between each demographic characteristic and reaching out status as fixed effects (Table 3 in the paper). The codes below generate model estimation with the interaction term between first generation status and reaching out status.

```{r}
# Table 3, Model 2
First_26 <- lm(Next ~ Reachout*Firstgen + c_running, data = filter(Data_comp, c_running>= -13 & c_running <=13))
summary(First_26)
```

The focal coefficient that we are looking at is **Reaching:Firstgen**, indicating the interaction term between first generation status and reaching out status. The estimate is -0.328 and not significant. 

## 6. Sensitivity analyses
In the paper, we demonstrated three sets of sensitivity analyses that were critical in strengthening the internal validity. 

First, we can visually check whether there are any other discontinuities at hypothetical thresholds. For example, codes below can create Figure 6 in the paper.

```{r warning=FALSE, message = FALSE}
# Figure 6
Data_comp <- Data_comp %>%  #create a fake cutoff at 85 points. Readers may select multiple cutoff points other than the real cutoff.
  mutate(
    fake_cutoff = case_when(
      Running >=85 ~ "0",
      Running < 85 ~ "1",
      TRUE ~ "NA"
    )
  )

Data_comp %>%
  ggplot(aes(x = Running, y = Next, color = as.factor(fake_cutoff)))+
  ggtitle("Figure 6. Sensitivity analysis: Placebo test using a hypothetical \n reach-out point at 85 points (Bandwidth = 26 points). ") +
  geom_point(size = 1.5, alpha = 0.5) +
  geom_smooth(data = filter(Data_comp, Running >=85), method = "lm", se = F)+
  geom_smooth(data = filter(Data_comp, Running < 85), method = "lm", se = F)+
  geom_vline(xintercept = 85) +
  scale_x_continuous(breaks = seq(70, 100, by = 5))+
  scale_y_continuous(breaks = seq(30, 100, by = 5))+
  xlim(72,98)+ ylim(30,100)+ scale_color_manual(values=c("mediumpurple", "#E69F00"))+
  labs(x = "Cumulative Grade Before Reaching Out", y = "Next Exam", color = "Hypothetical Reachout")+
  theme(
    panel.border = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
    panel.grid = element_blank(),
    legend.key = element_rect(fill = "transparent", color = NA)
  )
```

Second, we can run models with random effects to consider nested structure in the example data. In the paper, we consider two different structures of random effects, the instructor random effect and the section-TA random effect. For example, codes below can run the multilevel model with instructor ID, Section, and Section-TA combination as random intercepts.
```{r}
# Instructor ID as random intercepts
model_re1<- lmer(Next ~ Reachout + c_running + (1 | Instructor), data = filter(Data_comp, c_running>= -13 & c_running <=13))
summary (model_re1)
# Section ID as random intercepts
model_re2<- lmer(Next ~ Reachout + c_running + (1 | Section), data = filter(Data_comp, c_running>= -13 & c_running <=13))
summary (model_re2)
# Section - TA combined ID as random intercepts
model_re3<- lmer(Next ~ Reachout + c_running + (1 | Section_TA), data = filter(Data_comp, c_running>= -13 & c_running <=13))
summary (model_re3)
```

Additionally, in the Supp. material, we present model selection for three multilevel models with different random intercept structures. 
```{r}
modelsummary(list(model_re1, model_re2, model_re3))
```

Furthermore, with the same model specification, we can create bandwidth selection figure (Figure 7 in the paper). Codes are shown below.
```{r warning=FALSE, message = FALSE}
# Figure 7a
results <- data.frame(Bandwidth = integer(), 
                      Treatment_Effect = numeric(), 
                      CI_Lower = numeric(), 
                      CI_Upper = numeric(), 
                      p_value = numeric())

for (bw in seq(1,30, by = 0.5)) {
  subset_data <- subset(Data_comp, abs(c_running) <= bw)
  model <- lmer(Next ~ Reachout + c_running + (1 | Instructor), data = subset_data)
  treatment_effect <- fixef(model)["Reachout"]
  conf_int <- confint(model, parm = "Reachout", level = 0.95, method = "Wald")
  se <- sqrt(vcov(model)["Reachout", "Reachout"])
  t_value <- treatment_effect / se
  p_value <- 2 * pt(-abs(t_value), df.residual(model))

  results <- rbind(results, 
                   data.frame(Bandwidth = bw*2, 
                              Treatment_Effect = treatment_effect, 
                              CI_Lower = conf_int[1], 
                              CI_Upper = conf_int[2], 
                              p_value = p_value))
}

results <- results %>%
  mutate(Significance = ifelse(p_value < 0.05, "Significant", "Not Significant"))

results <- results %>%
  mutate(Group = cumsum(Significance != lag(Significance, default = first(Significance))))

plot_next_re <-  ggplot(results, aes(x = Bandwidth, y = Treatment_Effect, color = Significance)) +
  ggtitle("Figure 7. Sensitive analysis: testing RD model specifications \n with different random intercept structures. ") +
  geom_line(aes(group = Group), size = 1) +  # Group by continuous segments
  geom_line(aes(y = CI_Lower, linetype = "Confidence Interval"), color = "black", show.legend = TRUE) +
  geom_line(aes(y = CI_Upper, linetype = "Confidence Interval"), color = "black", show.legend = TRUE) +
  geom_point(aes(shape = Significance), size = 2) +  # Points to indicate significance
  scale_color_manual(values = c("Significant" = "mediumpurple", "Not Significant" = "#E69F00")) +
  scale_linetype_manual(name = "Legend", values = c("Confidence Interval" = "dashed")) +
  labs(x = "Bandwidth",
       y = "Treatment Effect on the Next Exam") +
  theme_minimal() +
  guides(
    color = guide_legend(title = "Significance at .05 Level"),
    linetype = guide_legend(title = "95% Confidence Interval"),
    shape = guide_legend(title = "Significance at .05 Level")
  ) +
  theme(
    panel.border = element_rect(fill = "transparent"),
    panel.background = element_rect(fill = "transparent"),
  ) +
  scale_y_continuous(breaks = seq(-10,20, by = 1)) + ylim(-15,20) +
  scale_x_continuous(breaks = seq(0,60, by = 10))

plot_next_re
```

Finally, an alternative learning outcome and be used to strengthen the robustness of the results. The codes below can generate the baseline RD estimation of an alternative learning outcomes, the final grades. 
```{r}
baseline_alt <- lm(Grade ~ Reachout + c_running, data = filter(Data_comp, c_running>= -13 & c_running <=13))
summary(baseline_alt)
```

The estimated intervention effect at a bandwidth of 26 points is 2.08 points and is significant at 0.05 level. 








